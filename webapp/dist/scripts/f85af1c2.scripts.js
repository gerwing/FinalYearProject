"use strict";var app=angular.module("voteApp",["ngRoute","ngResource","tc.chartjs"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/teacher",{templateUrl:"views/teacher/teacher.html",controller:"TeacherCtrl"}).when("/teacher/login",{templateUrl:"views/teacher/login.html",controller:"LoginCtrl"}).when("/teacher/modules/:id",{templateUrl:"views/teacher/module.html",controller:"ModuleCtrl"}).when("/teacher/lectures/:id",{templateUrl:"views/teacher/lecture.html",controller:"LectureCtrl"}).when("/teacher/lectures/live/:id",{templateUrl:"views/teacher/liveLecture.html",controller:"LiveLectureCtrl"}).when("/teacher/homework/:id",{templateUrl:"views/teacher/homework.html",controller:"HomeworkCtrl"}).when("/student/login",{templateUrl:"views/student/login.html",controller:"StdLoginCtrl"}).when("/student",{templateUrl:"views/student/student.html",controller:"StudentCtrl"}).when("/student/lectures/:id",{templateUrl:"views/student/lecture.html",controller:"StdLectureCtrl"}).when("/student/joinLecture/:accessID",{templateUrl:"views/student/lecture.html",controller:"StdaIDLectureCtrl"}).when("/student/homework/:id",{templateUrl:"views/student/homework.html",controller:"StdHomeworkCtrl"}).when("/verify/:token",{templateUrl:"views/verify.html",controller:"VerifyCtrl"}).when("/resetPassword",{templateUrl:"views/passwordSubmit.html",controller:"PasswordResetCtrl"}).when("/resetPassword/:token",{templateUrl:"views/passwordReset.html",controller:"PasswordResetCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]);app.run(["$http","$rootScope","$location","Authentication",function(a,b,c,d){d.getCurrentUser(),b.logout=d.logout}]),angular.module("voteApp").controller("HomeCtrl",["$scope",function(){}]),angular.module("voteApp").controller("VerifyCtrl",["$scope","$routeParams","$location","$timeout","$http",function(a,b,c,d,e){var f=b.token;e.post("/api/user/verify/"+f,{}).success(function(b){a.verified=!0,a.name=b.name,b.isTeacher?d(function(){c.path("/teacher/login")},4e3):d(function(){c.path("/student/login")},4e3)}).error(function(b){a.verified=!1,a.errorMessage=b.message})}]),angular.module("voteApp").controller("PasswordResetCtrl",["$scope","$routeParams","$location","$timeout","$http",function(a,b,c,d,e){a.passwordSubmit=function(){e.post("/api/user/resetPassword",{email:a.email}).success(function(){a.submitted=!0,d(function(){c.path("/")},5e3)}).error(function(b){a.errorMessage=b.message})},a.resetPassword=function(){var f=b.token;e.post("/api/user/resetPassword/"+f,{password:a.newPassword}).success(function(){a.reset=!0,d(function(){c.path("/")},5e3)}).error(function(b){a.errorMessage=b.message})}}]),angular.module("voteApp").controller("LoginCtrl",["$scope","$http","Authentication",function(a,b,c){a.login=function(){c.loginTeacher(a)},a.register=function(){c.registerTeacher(a)},a.resendVerification=function(){b.post("/api/user/verify/resend",{user:a.user}),a.verificationSent=!0}}]),angular.module("voteApp").controller("TeacherCtrl",["$scope","$http","$rootScope","$timeout","$window","Module","Authentication",function(a,b,c,d,e,f,g){g.verifyTeacher()&&(a.modules=f.query(),a.addModule=function(){f.save({},a.module,function(b){a.modules.push(b),delete a.module})},a.saveModule=function(b){a.modules[b].changed=!0},a.saveModules=function(){a.editing=!1;for(var b=0;b<a.modules.length;b++)if(a.modules[b].changed){var c=a.modules[b];delete c.changed,f.update({id:c._id},{name:c.name})}},a.removeModule=function(b){var c=a.modules.splice(b,1);c[0].$delete()},a.updateTeacher=function(){b.put("/api/teacher/"+c.user._id,c.user).success(function(){a.updateSuccess=!0,d(function(){a.updateSuccess=!1},3e3)})},a.updatePassword=function(){b.put("/api/user/changePassword/"+c.user._id,{oldPassword:a.oldPassword,newPassword:a.newPassword}).success(function(){a.passwordSuccess=!0,d(function(){a.passwordSuccess=!1},3e3)}).error(function(b,c){401===c&&(a.errorMessage=b.message,a.passwordError=!0,d(function(){a.passwordError=!1},3e3))})},a.deleteProfile=function(){b.delete("/api/student/"+c.user._id,{}).success(function(){delete c.user,e.location.reload()})})}]),angular.module("voteApp").controller("ModuleCtrl",["$scope","$routeParams","Module","Lecture","Homework","Authentication",function(a,b,c,d,e,f){f.verifyTeacher()&&(a.module=c.get({id:b.id}),a.addLecture=function(){if(a.lecture)var b=a.lecture;else var b={};b.module=a.module._id,d.save({},b,function(b){a.module.lectures.push(b),delete a.lecture})},a.saveLecture=function(b){a.module.lectures[b].changed=!0},a.saveLectures=function(){a.editLectures=!1;for(var b=0;b<a.module.lectures.length;b++)if(a.module.lectures[b].changed){var c=a.module.lectures[b];delete c.changed,d.update({id:c._id},{name:c.name})}},a.removeLecture=function(b){var c=a.module.lectures.splice(b,1);d.delete({id:c[0]._id})},a.addHomework=function(){if(a.homework)var b=a.homework;else var b={};b.module=a.module._id,e.save({},b,function(b){a.module.homework.push(b),delete a.homework})},a.saveHomework=function(b){a.module.homework[b].changed=!0},a.saveHomeworks=function(){a.editHomework=!1;for(var b=0;b<a.module.homework.length;b++)if(a.module.homework[b].changed){var c=a.module.homework[b];delete c.changed,e.update({id:c._id},{name:c.name})}},a.removeHomework=function(b){var c=a.module.homework.splice(b,1);e.delete({id:c[0]._id})},a.addEmailRestriction=function(){a.module.emailRestrictions.push(a.emailRestriction),delete a.emailRestriction,c.update({id:a.module._id},{emailRestrictions:a.module.emailRestrictions})},a.removeEmailRestriction=function(b){var d=a.module.emailRestrictions;d.splice(d.indexOf(b),1),c.update({id:a.module._id},{emailRestrictions:a.module.emailRestrictions})})}]),angular.module("voteApp").controller("LectureCtrl",["$scope","$routeParams","$timeout","$location","Lecture","Authentication",function(a,b,c,d,e,f){if(f.verifyTeacher()){a.lecture=e.get({id:b.id},function(){for(var b=0,c=0,d=0;d<a.lecture.questions.length;d++){var e=a.lecture.questions[d];e.chartData=[{value:e.timesRight,color:"#55dd55"},{value:e.timesWrong,color:"#dd5555"}],e.timesRight+e.timesWrong===0?(e.rightScore=0,e.wrongScore=0):(e.rightScore=Math.round(e.timesRight/(e.timesRight+e.timesWrong)*1e3)/10,e.wrongScore=Math.round(e.timesWrong/(e.timesRight+e.timesWrong)*1e3)/10),b+=e.timesRight,c+=e.timesWrong}a.understanding=b+c===0?0:Math.round(b/(b+c)*1e3)/10});var g=!1;a.addQuestion=function(){a.question={answers:[{}]},g=!0},a.editQuestion=function(b){a.question=a.lecture.questions[b],g=!1},a.removeQuestion=function(b){a.lecture.questions.splice(b,1),e.update({id:a.lecture._id},a.lecture)},a.saveQuestion=function(){g&&(a.lecture.questions.push(a.question),g=!1),e.update({id:a.lecture._id},a.lecture,function(){a.saveSuccess=!0,c(function(){a.saveSuccess=!1},3e3)})},a.addAnswer=function(){var b={};a.question.answers.push(b)},a.removeAnswer=function(b){a.question.answers.splice(b,1)},a.makeLive=function(){a.lecture.isLive=!0,e.update({id:a.lecture._id},a.lecture)},a.generateID=function(){e.generateID({id:a.lecture._id},{},function(){a.lecture=e.get({id:b.id})})},a.removeID=function(){e.removeID({id:a.lecture._id},{},function(){a.lecture=e.get({id:b.id})})}}}]),angular.module("voteApp").controller("LiveLectureCtrl",["$scope","$routeParams","Lecture","Authentication","SocketIO",function(a,b,c,d,e){d.verifyTeacher()&&(e.socket.connect(),e.emit("join",b.id),a.participators=0,a.answered=0,e.on("studentConnect",function(){a.participators+=1,a.$apply()}),e.on("studentDisconnect",function(){a.participators-=1,a.$apply()}),e.on("newAnswer",function(){a.answered+=1,a.$apply()}),a.$on("$locationChangeStart",function(){a.lecture.isLive=!1,c.update({id:a.lecture._id},{isLive:!1},function(){e.disconnect()})}),window.onbeforeunload=function(){a.lecture.isLive=!1,c.update({id:a.lecture._id},{isLive:!1})},a.lecture=c.get({id:b.id},function(){a.question=a.lecture.questions[0],a.currentQuestion=0,a.lastAnswered=0}),a.nextQuestion=function(){a.resultview=!1,a.currentQuestion+=1,a.answered=0,a.question=a.lecture.questions[a.currentQuestion],a.lastAnswered<a.currentQuestion&&(a.lastAnswered=a.currentQuestion),e.emit("changeQuestion",a.currentQuestion)},a.showResults=function(){a.resultview=!0;for(var b,c=0;c<a.question.answers.length;c++)if(a.question.answers[c].correct){b=a.question.answers[c].answer;break}e.emit("results",b)},a.endLecture=function(){a.finished=!0,e.emit("finished")},a.gotoQuestion=function(b){a.currentQuestion=b,a.question=a.lecture.questions[a.currentQuestion]})}]),angular.module("voteApp").controller("HomeworkCtrl",["$scope","$routeParams","$timeout","$location","Homework","Authentication",function(a,b,c,d,e,f){if(f.verifyTeacher()){a.homework=e.get({id:b.id},function(){for(var b=0,c=0,d=0;d<a.homework.questions.length;d++){var e=a.homework.questions[d];e.chartData=[{value:e.timesRight,color:"#55dd55"},{value:e.timesWrong,color:"#dd5555"}],e.timesRight+e.timesWrong===0?(e.rightScore=0,e.wrongScore=0):(e.rightScore=Math.round(e.timesRight/(e.timesRight+e.timesWrong)*1e3)/10,e.wrongScore=Math.round(e.timesWrong/(e.timesRight+e.timesWrong)*1e3)/10),b+=e.timesRight,c+=e.timesWrong}a.understanding=b+c===0?0:Math.round(b/(b+c)*1e3)/10});var g=!1;a.addQuestion=function(){a.question={answers:[{}]},g=!0},a.editQuestion=function(b){a.question=a.homework.questions[b],g=!1},a.removeQuestion=function(b){a.homework.questions.splice(b,1),e.update({id:a.homework._id},a.homework)},a.saveQuestion=function(){g&&(a.homework.questions.push(a.question),g=!1),e.update({id:a.homework._id},a.homework,function(){a.saveSuccess=!0,c(function(){a.saveSuccess=!1},3e3)})},a.addAnswer=function(){var b={};a.question.answers.push(b)},a.removeAnswer=function(b){a.question.answers.splice(b,1)},a.makeLive=function(){a.homework.isLive=!0,e.update({id:a.homework._id},a.homework)},a.stopHomework=function(){a.homework.isLive=!1,e.update({id:a.homework._id},a.homework)}}}]),angular.module("voteApp").controller("StdLoginCtrl",["$scope","$location","$http","Authentication","Lecture",function(a,b,c,d,e){a.password="",a.login=function(){d.loginStudent(a)},a.register=function(){d.registerStudent(a)},a.reset=function(){a.usernameError&&delete a.usernameError},a.joinLecture=function(){a.lectureError=!1,a.aidLecture=e.getAccessIDLecture({accessID:a.accessID},function(){b.path("/student/joinLecture/"+a.accessID)},function(b){a.lectureError=!0,a.errorMessage=b.data.message})},a.resendVerification=function(){c.post("/api/user/verify/resend",{user:a.user}),a.verificationSent=!0}}]),angular.module("voteApp").controller("StudentCtrl",["$scope","$http","$timeout","$rootScope","$window","Authentication","Module","Homework","Lecture",function(a,b,c,d,e,f,g,h,i){if(f.verifyStudent()){var j=function(){a.homework=h.getAllHomework(),a.lectures=i.getAllLectures(),a.modules=g.getSubscribed()};j(),a.subscribeModule=function(d){a.subscribeError=!1;var e;e=d?d:a.module.id,b.post("/api/student/subscribe",{id:e}).success(function(b){f.setCurrentUser(b),delete a.searchResults,delete a.module.name,j()}).error(function(b,d){(404===d||409===d||401===d)&&(a.subscribeError=!0,c(function(){a.subscribeError=!1},3e3),a.errorMessage=b.message,c(function(){a.errorMessage=null},3e3))}),delete a.module.id},a.unsubscribeModule=function(a){b.post("/api/student/unsubscribe",{id:a}).success(function(a){f.setCurrentUser(a),j()})},a.searchModules=function(){a.searchError=!1,a.searchResults=g.search({name:a.module.name},function(){0===a.searchResults.length&&(a.searchError=!0,c(function(){a.searchError=!1},3e3))})},a.updatePassword=function(){b.put("/api/user/changePassword/"+d.user._id,{oldPassword:a.oldPassword,newPassword:a.newPassword}).success(function(){a.passwordSuccess=!0,c(function(){a.passwordSuccess=!1},3e3)}).error(function(b,d){401===d&&(a.errorMessage=b.message,a.passwordError=!0,c(function(){a.passwordError=!1,delete a.errorMessage},3e3))})},a.deleteProfile=function(){b.delete("/api/student/"+d.user._id,{}).success(function(){delete d.user,e.location.reload()})},a.CH=!1,a.LL=!1,a.SM=!1,a.MS=!1,a.AH=!1,a.CL=!1,a.SR=!1,a.toggleCH=function(){a.CH=!a.CH},a.toggleAH=function(){a.AH=!a.AH},a.toggleLL=function(){a.LL=!a.LL},a.toggleSM=function(){a.SM=!a.SM},a.toggleMS=function(){a.MS=!a.MS},a.toggleCL=function(){a.CL=!a.CL},a.toggleSR=function(){a.SR=!a.SR}}}]),angular.module("voteApp").controller("StdLectureCtrl",["$scope","$routeParams","Lecture","SocketIO","Authentication",function(a,b,c,d,e){e.verifyStudent()&&(d.socket.connect(),d.on("gotoQuestion",function(b){a.question=a.lecture.questions[b],a.currentQuestion=b,a.resultview=!1,a.waiting=!1,a.$apply()}),d.on("showResults",function(b){a.answers[a.currentQuestion].answer===b?a.answers[a.currentQuestion].correct=!0:(a.answers[a.currentQuestion].correct=!1,a.correctAnswer=b),a.resultview=!0,a.waiting=!1,a.$apply()}),d.on("finish",function(){a.finished||c.submit({id:a.lecture._id},a.answers),a.finished=!0,a.$apply()}),a.$on("$locationChangeStart",function(){d.disconnect()}),a.lecture=c.getLecture({id:b.id},function(){if(a.lecture.submission)a.answers=a.lecture.submission.results,a.finished=!0;else{a.question=a.lecture.questions[0],a.currentQuestion=0,a.answered=!1,a.resultview=!1,a.answers=[];for(var c=0;c<a.lecture.questions.length;c++)a.answers[c]={question:a.lecture.questions[c].question};d.emit("join",b.id)}}),a.setAnswered=function(){a.answered=!0},a.answerQuestion=function(){d.emit("answer",a.answers[a.currentQuestion].answer),a.waiting=!0})}]),angular.module("voteApp").controller("StdaIDLectureCtrl",["$scope","$routeParams","Lecture","SocketIO",function(a,b,c,d){d.socket.connect(),d.on("gotoQuestion",function(b){a.question=a.lecture.questions[b],a.currentQuestion=b,a.resultview=!1,a.waiting=!1,a.$apply()}),d.on("showResults",function(b){a.answers[a.currentQuestion].answer===b?a.answers[a.currentQuestion].correct=!0:(a.answers[a.currentQuestion].correct=!1,a.correctAnswer=b),a.resultview=!0,a.waiting=!1,a.$apply()}),d.on("finish",function(){a.finished||c.submitAccessID({accessID:b.accessID},a.answers),a.finished=!0,a.$apply()}),a.$on("$locationChangeStart",function(){d.disconnect()}),a.lecture=c.getAccessIDLecture({accessID:b.accessID},function(){if(a.lecture.submission)a.answers=a.lecture.submission.results,a.finished=!0;else{a.question=a.lecture.questions[0],a.currentQuestion=0,a.answered=!1,a.resultview=!1,a.answers=[];for(var b=0;b<a.lecture.questions.length;b++)a.answers[b]={question:a.lecture.questions[b].question};d.emit("join",a.lecture._id)}}),a.setAnswered=function(){a.answered=!0},a.answerQuestion=function(){d.emit("answer",a.answers[a.currentQuestion].answer),a.waiting=!0}}]),angular.module("voteApp").controller("StdHomeworkCtrl",["$scope","$routeParams","Homework","Authentication",function(a,b,c,d){d.verifyStudent()&&(a.homework=c.getHomework({id:b.id},function(){if(a.homework.submission)a.results=a.homework.submission.results,a.finished=!0;else{a.question=a.homework.questions[0],a.currentQuestion=0,a.lastAnswered=0,a.answered=[],a.answers=[];for(var b=0;b<a.homework.questions.length;b++)a.answered[b]=!1,a.answers[b]={question:a.homework.questions[b].question}}}),a.nextQuestion=function(){a.currentQuestion+=1,a.question=a.homework.questions[a.currentQuestion],a.lastAnswered<a.currentQuestion&&(a.lastAnswered=a.currentQuestion)},a.submitHomework=function(){c.submit({id:a.homework._id},a.answers,function(b){a.finished=!0,a.results=b})},a.setAnswered=function(){a.answered[a.currentQuestion]=!0},a.gotoQuestion=function(b){a.currentQuestion=b,a.question=a.homework.questions[a.currentQuestion]})}]),angular.module("voteApp").factory("Authentication",["$http","$rootScope","$location",function(a,b,c){var d=function(d,e){var f={username:d.username,password:d.password};a.post(e,f).success(function(a){b.user=a,b.lastPath?(c.path(b.lastPath),delete b.lastPath):c.path(a.isTeacher?"/teacher":"/student")}).error(function(a,b){401===b&&("username"===a.problem?(d.usernameError=!0,d.passwordError=!1,d.verificationError=!1):"password"===a.problem?(d.usernameError=!1,d.passwordError=!0,d.verificationError=!1):"verification"===a.problem&&(d.verificationError=!0,d.user=a.id,d.usernameError=!1,d.passwordError=!1),d.errorMessage=a.message)})},e=function(b,c,d){a.post(c,d).success(function(){b.registered=!0,b.registering=!1}).error(function(a,c){409===c?(b.usernameConflict=!0,b.errorMessage=a.message):406===c&&(b.missingFields=!0,b.errorMessage=a)})};return{loginTeacher:function(a){d(a,"/api/teacher/login")},loginStudent:function(a){d(a,"/api/student/login")},registerStudent:function(a){var b={username:a.username,password:a.password};e(a,"/api/student/register",b)},registerTeacher:function(a){var b={username:a.username,password:a.password,name:a.name,email:a.email};e(a,"/api/teacher/register",b)},logout:function(){a.post("/api/user/logout").success(function(){c.path("/"),delete b.user})},getCurrentUser:function(){a({method:"GET",url:"/api/currentUser"}).success(function(a){a&&(b.user=a)})},setCurrentUser:function(a){b.user=a},verifyTeacher:function(){return b.user&&b.user.isTeacher?!0:(b.lastPath=c.path(),c.path("/teacher/login"),!1)},verifyStudent:function(){return b.user?!0:(b.lastPath=c.path(),c.path("/student/login"),!1)}}}]),angular.module("voteApp").factory("Module",["$resource",function(a){return a("/api/teacher/modules/:id",{id:"@_id"},{update:{method:"PUT"},getSubscribed:{method:"GET",url:"/api/student/subscribed",isArray:!0},search:{method:"GET",url:"/api/student/modules/search",isArray:!0}})}]),angular.module("voteApp").factory("Lecture",["$resource",function(a){return a("/api/teacher/lectures/:id",{id:"@_id"},{update:{method:"PUT"},getAllLectures:{method:"GET",url:"/api/student/lectures"},getLecture:{method:"GET",url:"/api/student/lectures/:id"},getAccessIDLecture:{method:"GET",url:"/api/student/lectures/aid/:accessID"},submit:{method:"POST",url:"/api/student/lectures/:id"},submitAccessID:{method:"POST",url:"/api/student/lectures/aid/:accessID"},generateID:{method:"PUT",url:"/api/teacher/lectures/:id/accessID"},removeID:{method:"DELETE",url:"/api/teacher/lectures/:id/accessID"}})}]),angular.module("voteApp").factory("Homework",["$resource",function(a){return a("/api/teacher/homework/:id",{id:"@_id"},{update:{method:"PUT"},getHomework:{method:"GET",url:"/api/student/homework/:id"},getAllHomework:{method:"GET",url:"/api/student/homework"},submit:{method:"POST",url:"/api/student/homework/:id",isArray:!0}})}]),angular.module("voteApp").factory("SocketIO",function(){var a=io.connect();return a});